<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Retrosynthesis" href="retrosynthesis.html" /><link rel="prev" title="Pretrained Molecular Representations" href="pretrain.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>Molecule Generation - TorchDrug 0.1.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --font-stack: Helvetica, Arial, sans-serif, -apple-system;
  --font-stack--monospace: Courier, monospace;
  --color-brand-primary: #E5261F;
  --color-brand-content: #E5261F;
  --admonition-font-size: 1rem;
  --admonition-title-font-size: 1rem;
  --font-size--small--2: var(--font-size--small);
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">TorchDrug 0.1.2 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="https://torchdrug.ai">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../benchmark/index.html">Benchmark</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/property_prediction.html">Molecule Property Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/pretrain.html">Pretrained Molecular Representations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/generation.html">Molecule Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/retrosynthesis.html">Retrosynthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/reasoning.html">Knowledge Graph Reasoning</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="property_prediction.html">Property Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="pretrain.html">Pretrained Molecular Representations</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Molecule Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="retrosynthesis.html">Retrosynthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="reasoning.html">Knowledge Graph Reasoning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes/index.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notes/graph.html">Graph Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/variadic.html">Batch Irregular Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/layer.html">Graph Neural Network Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/model.html">Customize Models &amp; Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/reference.html">Deal with References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../paper.html">Papers Implemented</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/core.html">torchdrug.core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/data.html">torchdrug.data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/datasets.html">torchdrug.datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/transforms.html">torchdrug.transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/metrics.html">torchdrug.metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/layers.html">torchdrug.layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/models.html">torchdrug.models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/tasks.html">torchdrug.tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">torchdrug.utils</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="molecule-generation">
<h1>Molecule Generation<a class="headerlink" href="#molecule-generation" title="Permalink to this headline">#</a></h1>
<p>Molecular graph generation is a fundamental problem for drug discovery and has
been attracting growing attention. The problem is challenging since it requires
not only generating chemically valid molecular structures but also optimizing
their chemical properties in the meantime.</p>
<p>In this tutorial, we will implement two graph generative models <a class="reference external" href="https://papers.nips.cc/paper/7877-graph-convolutional-policy-network-for-goal-directed-molecular-graph-generation.pdf">GCPN</a> and
<a class="reference external" href="https://arxiv.org/pdf/2001.09382.pdf">GraphAF</a>. We first pretrain both models on <a class="reference external" href="https://pubs.acs.org/doi/pdfplus/10.1021/ci3001277">ZINC250k</a> dataset. Starting from
the pretrained checkpoint, we finetune both models with reinforcement learning to
optimize two properties (i.e., QED and penalized logP score) of generated
molecules.</p>
<section id="prepare-the-pretraining-dataset">
<h2>Prepare the Pretraining Dataset<a class="headerlink" href="#prepare-the-pretraining-dataset" title="Permalink to this headline">#</a></h2>
<p>We use <a class="reference external" href="https://pubs.acs.org/doi/pdfplus/10.1021/ci3001277">ZINC250k</a> dataset for pretraining. The dataset contains 250,000 drug-like
molecules with a maximum atom number of 38. It has 9 atom types and 3 edge types.</p>
<p>First, let’s donwload, load, and preprocess the dataset, which takes about 3-5 minutes.
You are encouraged to dump the preprocessed dataset to save the time for future use.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ZINC250k</span><span class="p">(</span><span class="s2">"~/molecule-datasets/"</span><span class="p">,</span> <span class="n">kekulize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">node_feature</span><span class="o">=</span><span class="s2">"symbol"</span><span class="p">)</span>
<span class="c1"># with open("path_to_dump/zinc250k.pkl", "wb") as fout:</span>
<span class="c1">#     pickle.dump(dataset, fout)</span>
<span class="c1"># with open("path_to_dump/zinc250k.pkl", "rb") as fin:</span>
<span class="c1">#     dataset = pickle.load(fin)</span>
</pre></div>
</div>
</section>
<section id="define-the-model-gcpn">
<h2>Define the Model: GCPN<a class="headerlink" href="#define-the-model-gcpn" title="Permalink to this headline">#</a></h2>
<p>The model consists of two parts, a graph representation model and a graph generative
module. We define a Relational Graph Convolutional Networks (<a class="reference external" href="https://arxiv.org/abs/1703.06103.pdf">RGCN</a>) as our
representation model. We use the module
<a class="reference internal" href="../api/tasks.html#torchdrug.tasks.GCPNGeneration" title="torchdrug.tasks.GCPNGeneration"><code class="xref py py-class docutils literal notranslate"><span class="pre">GCPNGeneration</span></code></a> as the training task
for GCPN.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tasks</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RGCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">node_feature_dim</span><span class="p">,</span>
                    <span class="n">num_relation</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span><span class="p">,</span>
                    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">GCPNGeneration</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">atom_types</span><span class="p">,</span> <span class="n">max_edge_unroll</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                            <span class="n">max_node</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s2">"nll"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pretraining-and-generation-gcpn">
<h2>Pretraining and Generation: GCPN<a class="headerlink" href="#pretraining-and-generation-gcpn" title="Permalink to this headline">#</a></h2>
<p>Now we can train our model. We setup an optimizer for our model, and put
everything together into an Engine instance.
Here we only train the model for 1 epoch, and then save the pretrained model into a directory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
                     <span class="n">gpus</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/gcpn_zinc250k_1epoch.pkl"</span><span class="p">)</span>
</pre></div>
</div>
<p>During the pretraining procedure, we may obtain some logs as follows, which report
the accuracy of action predictions.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>edge acc: <span class="m">0</span>.896366
edge loss: <span class="m">0</span>.234644
node1 acc: <span class="m">0</span>.596209
node1 loss: <span class="m">1</span>.04997
node2 acc: <span class="m">0</span>.747235
node2 loss: <span class="m">0</span>.723717
stop acc: <span class="m">0</span>.849681
stop bce loss: <span class="m">0</span>.247942
total loss: <span class="m">2</span>.25627
</pre></div>
</div>
<p>After the model is pretrained, we can load the parameters from the checkpoint as follows.
Let’s generate some small molecules from the pretrained GCPN model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/gcpn_zinc250k_1epoch.pkl"</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">num_sample</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">max_resample</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">())</span>
</pre></div>
</div>
<p>The results are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">C</span><span class="o">=</span>S<span class="o">(</span>C<span class="o">)</span>CC<span class="o">(=</span>O<span class="o">)</span>NC<span class="o">(</span>CCN<span class="o">)</span>CCCC
CCN<span class="o">(</span>C<span class="o">)</span>C1<span class="o">(</span><span class="nv">C2NC2</span><span class="o">=</span>O<span class="o">)</span>CCCC1C
<span class="nv">CC1</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C1C<span class="o">(=</span>O<span class="o">)</span>N1CC1CS
<span class="nv">CN</span><span class="o">=</span><span class="nv">NC1</span><span class="o">=</span><span class="nv">NC</span><span class="o">=</span><span class="nv">CC2</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C<span class="o">(</span><span class="nv">C</span><span class="o">=</span>C2<span class="o">)</span>CCNC<span class="o">(=</span>O<span class="o">)</span>C1
CC<span class="o">(</span>CC<span class="o">(=</span>O<span class="o">)</span><span class="nv">NC1</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C<span class="o">(</span>N<span class="o">)</span><span class="nv">C2</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C12<span class="o">)</span><span class="nv">C1</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C1
...
</pre></div>
</div>
<p>Let’s visualize some generated molecules.</p>
<img alt="../_images/zinc250k_gcpn_pretrain_generated.png" src="../_images/zinc250k_gcpn_pretrain_generated.png"/>
</section>
<section id="goal-directed-molecule-generation-with-reinforcement-learning-gcpn">
<h2>Goal-Directed Molecule Generation with Reinforcement Learning: GCPN<a class="headerlink" href="#goal-directed-molecule-generation-with-reinforcement-learning-gcpn" title="Permalink to this headline">#</a></h2>
<p>For drug discovery, we need to optimize the chemical properties of generated
molecules. In this part, we introduce how to fine-tune the graph generative model
with reinforcement learning to optimize the properties of generated molecules. We
implemented the Proximal Policy Optimization (PPO) algorithm for both GCPN and
GraphAF. To finetune the pretrained model with reinforcement learning, we only
need to modify several lines of code in the task initialization. We provide all the
codes for finetuning in the following segment.</p>
<p>For Penalized logP optimization, the code is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ZINC250k</span><span class="p">(</span><span class="s2">"~/molecule-datasets/"</span><span class="p">,</span> <span class="n">kekulize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">node_feature</span><span class="o">=</span><span class="s2">"symbol"</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RGCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">node_feature_dim</span><span class="p">,</span>
                    <span class="n">num_relation</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span><span class="p">,</span>
                    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">GCPNGeneration</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">atom_types</span><span class="p">,</span>
                            <span class="n">max_edge_unroll</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_node</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span>
                            <span class="n">task</span><span class="o">=</span><span class="s2">"plogp"</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s2">"ppo"</span><span class="p">,</span>
                            <span class="n">reward_temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">agent_update_interval</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>


<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
                     <span class="n">gpus</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">solver</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/gcpn_zinc250k_1epoch.pkl"</span><span class="p">,</span>
            <span class="n">load_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># RL finetuning</span>
<span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/gcpn_zinc250k_1epoch_finetune.pkl"</span><span class="p">)</span>
</pre></div>
</div>
<p>The results are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="m">6</span>.56, <span class="s1">'CCCCC(CCC)(CCCC)C(C)C(C)(CCC)C(CCC)(CCC)C(C)(C(C)C)C(C)(C)CCCC'</span><span class="o">)</span>
<span class="o">(</span><span class="m">6</span>.46, <span class="s1">'CCCCC(CCC(C)C)(C(CC)(CCC)C(C)(C)CCC)C(CC(C)C)(CC(C)C)C(C)(C)C(C)(C)C'</span><span class="o">)</span>
<span class="o">(</span><span class="m">6</span>.40, <span class="s1">'CCCC(CCC)CC(C)(C(C)(C)C(C)(CC)CC)C(C)(C)C(C)(C(C)(C)CCC)C(C)(C)CCC'</span><span class="o">)</span>
<span class="o">(</span><span class="m">6</span>.18, <span class="s1">'CCCCC(CCC)CC(CC(C)C)C(C)(C)C(CCC)(C(C)CC)C(CCC)(CCCC)CCC(C)C'</span><span class="o">)</span>
...
</pre></div>
</div>
<p>Let’s visualize some molecules with large Penalized logP scores (&gt; 6).</p>
<img alt="../_images/zinc250k_gcpn_plogp_generated.png" src="../_images/zinc250k_gcpn_plogp_generated.png"/>
<p>For QED optimization, the task initialization is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">GCPNGeneration</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">atom_types</span><span class="p">,</span>
                            <span class="n">max_edge_unroll</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_node</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span>
                            <span class="n">task</span><span class="o">=</span><span class="s2">"qed"</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="p">(</span><span class="s2">"ppo"</span><span class="p">,</span> <span class="s2">"nll"</span><span class="p">),</span>
                            <span class="n">reward_temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">agent_update_interval</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
<p>The results are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="m">0</span>.948, <span class="s1">'C1=CC=C(CNC2=NC=NCC3=CN2C(C2=COCC2)=C3)C=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.948, <span class="s1">'CCC1=CC=CC=C1NC(=O)C12CC(=O)N(C1)C1=CC=CC=C12'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.947, <span class="s1">'O=C1CCNC(C2=CC=CN=C2)CN1CC1=CC=CC(Cl)=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.947, <span class="s1">'CC1=C(C(=O)NC2CCCN(C3=CC=CC=C3)C2)C=CN=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.947, <span class="s1">'CCNC1CCC2=CC=CC(=C2)N(C(=O)C2=CC=CC=N2)C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.946, <span class="s1">'O=C(C1=CC=CC=C1F)N1CC2=CC=CC=C2C(CCO)C1'</span><span class="o">)</span>
...
</pre></div>
</div>
<p>Let’s visualize some molecules with large QED scores (&gt; 0.945).</p>
<img alt="../_images/zinc250k_gcpn_qed_generated.png" src="../_images/zinc250k_gcpn_qed_generated.png"/>
</section>
<section id="define-the-model-graphaf">
<h2>Define the Model: GraphAF<a class="headerlink" href="#define-the-model-graphaf" title="Permalink to this headline">#</a></h2>
<p>The model consists of two parts, a graph representation model and a graph generative
module. We define a Relational Graph Convolutional Networks (<a class="reference external" href="https://arxiv.org/abs/1703.06103.pdf">RGCN</a>) as our
representation model. We use the module
<a class="reference internal" href="../api/tasks.html#torchdrug.tasks.AutoregressiveGeneration" title="torchdrug.tasks.AutoregressiveGeneration"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoregressiveGeneration</span></code></a> as
the training task for GraphAF. The task consists of a node flow model and an edge
flow model, which define invertible mapping between node / edge types and noise
distributions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">torchdrug.layers</span> <span class="kn">import</span> <span class="n">distribution</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RGCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_atom_type</span><span class="p">,</span>
                    <span class="n">num_relation</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span><span class="p">,</span>
                    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">num_atom_type</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_atom_type</span>
<span class="c1"># add one class for non-edge</span>
<span class="n">num_bond_type</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">node_prior</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">IndependentGaussian</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_atom_type</span><span class="p">),</span>
                                              <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_atom_type</span><span class="p">))</span>
<span class="n">edge_prior</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">IndependentGaussian</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bond_type</span><span class="p">),</span>
                                              <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_bond_type</span><span class="p">))</span>
<span class="n">node_flow</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GraphAF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">node_prior</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">edge_flow</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GraphAF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">edge_prior</span><span class="p">,</span> <span class="n">use_edge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">AutoregressiveGeneration</span><span class="p">(</span><span class="n">node_flow</span><span class="p">,</span> <span class="n">edge_flow</span><span class="p">,</span>
                                      <span class="n">max_node</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span> <span class="n">max_edge_unroll</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                      <span class="n">criterion</span><span class="o">=</span><span class="s2">"nll"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pretraining-and-generation-graphaf">
<h2>Pretraining and Generation: GraphAF<a class="headerlink" href="#pretraining-and-generation-graphaf" title="Permalink to this headline">#</a></h2>
<p>Now we can train our model. We setup an optimizer for our model, and put everything
together into an Engine instance. Here we train the model for 10 epochs, and then
save the pretrained model into a directory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
                     <span class="n">gpus</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/graphaf_zinc250k_10epoch.pkl"</span><span class="p">)</span>
</pre></div>
</div>
<p>After the model is pretrained, we can load the parameters from the checkpoint.
Let’s then generate some small molecules from the pretrained GraphAF model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">solver</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/graphaf_zinc250k_10epoch.pkl"</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">num_sample</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">())</span>
</pre></div>
</div>
<p>The results are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>CC<span class="o">(</span>C<span class="o">)</span><span class="nv">C</span><span class="o">=</span>C<span class="o">(</span>Cl<span class="o">)</span><span class="nv">NC1</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C1
CCOC<span class="o">(=</span>NNCC<span class="o">(</span><span class="nv">C</span><span class="o">=</span>CC<span class="o">(</span>C<span class="o">)=</span><span class="nv">CC</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>CC<span class="o">(</span>C<span class="o">)=</span><span class="nv">CC</span><span class="o">=</span>O<span class="o">)(</span>CO<span class="o">)</span>CO<span class="o">)</span>C<span class="o">(</span>C<span class="o">)</span>C
CCC<span class="o">(</span>C<span class="o">)(</span>NC<span class="o">(</span>C<span class="o">)</span>Cl<span class="o">)</span><span class="nv">C1</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>CNC#CO1
<span class="nv">O</span><span class="o">=</span><span class="nv">C1NC2</span><span class="o">=</span>CC<span class="o">(=</span><span class="nv">CC</span><span class="o">=</span>S<span class="o">)</span><span class="nv">C1</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span><span class="nv">CC</span><span class="o">=</span>C2
<span class="nv">C</span><span class="o">=[</span>SH<span class="o">]</span><span class="m">1</span><span class="o">(</span>CC<span class="o">)</span>C#SC<span class="o">(=</span>NC<span class="o">(</span>C<span class="o">)=</span>C<span class="o">(</span>C<span class="o">)</span>Cl<span class="o">)</span>C1N
...
</pre></div>
</div>
</section>
<section id="finetuning-graphaf">
<h2>Finetuning: GraphAF<a class="headerlink" href="#finetuning-graphaf" title="Permalink to this headline">#</a></h2>
<p>For Penalized logP optimization, the code is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">torchdrug.layers</span> <span class="kn">import</span> <span class="n">distribution</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ZINC250k</span><span class="p">(</span><span class="s2">"~/molecule-datasets/"</span><span class="p">,</span>
                            <span class="n">kekulize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">node_feature</span><span class="o">=</span><span class="s2">"symbol"</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RGCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_atom_type</span><span class="p">,</span>
                    <span class="n">num_relation</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span><span class="p">,</span>
                    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">num_atom_type</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_atom_type</span>
<span class="c1"># add one class for non-edge</span>
<span class="n">num_bond_type</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">node_prior</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">IndependentGaussian</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_atom_type</span><span class="p">),</span>
                                              <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_atom_type</span><span class="p">))</span>
<span class="n">edge_prior</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">IndependentGaussian</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bond_type</span><span class="p">),</span>
                                              <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_bond_type</span><span class="p">))</span>
<span class="n">node_flow</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GraphAF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">node_prior</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">edge_flow</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GraphAF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">edge_prior</span><span class="p">,</span> <span class="n">use_edge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">AutoregressiveGeneration</span><span class="p">(</span><span class="n">node_flow</span><span class="p">,</span> <span class="n">edge_flow</span><span class="p">,</span>
                                      <span class="n">max_node</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span> <span class="n">max_edge_unroll</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                      <span class="n">task</span><span class="o">=</span><span class="s2">"plogp"</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s2">"ppo"</span><span class="p">,</span>
                                      <span class="n">reward_temperature</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">baseline_momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                                      <span class="n">agent_update_interval</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>


<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
                     <span class="n">gpus</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">solver</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/graphaf_zinc250k_10epoch.pkl"</span><span class="p">,</span>
            <span class="n">load_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># RL finetuning</span>
<span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"path_to_dump/graphgeneration/graphaf_zinc250k_10epoch_finetune.pkl"</span><span class="p">)</span>
</pre></div>
</div>
<p>The results are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="m">5</span>.63, <span class="s1">'CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=C(I)C(C)(C)C'</span><span class="o">)</span>
<span class="o">(</span><span class="m">5</span>.60, <span class="s1">'CCC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC(C)(C)CCC'</span><span class="o">)</span>
<span class="o">(</span><span class="m">5</span>.44, <span class="s1">'CC=CC=CC=CC(Cl)=CC=CC=CC=CC=CC=C(C)C=CC=CC=C(C)C=CC(Br)=CC=CCCC'</span><span class="o">)</span>
<span class="o">(</span><span class="m">5</span>.35, <span class="s1">'CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=CC=C(CC)C(C)C'</span><span class="o">)</span>
...
</pre></div>
</div>
<p>For QED optimization, the task initialization is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">AutoregressiveGeneration</span><span class="p">(</span><span class="n">node_flow</span><span class="p">,</span> <span class="n">edge_flow</span><span class="p">,</span>
                                      <span class="n">max_node</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span> <span class="n">max_edge_unroll</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                      <span class="n">task</span><span class="o">=</span><span class="s2">"qed"</span><span class="p">,</span>
                                      <span class="n">criterion</span><span class="o">=</span><span class="p">{</span><span class="s2">"ppo"</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">"nll"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
                                      <span class="n">reward_temperature</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">baseline_momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                                      <span class="n">agent_update_interval</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
<p>The results are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="m">0</span>.948, <span class="s1">'O=S(=O)(NC1=CC=CC=C1Br)C1=CC=CC=N1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.947, <span class="s1">'CC1CCNC(C2=CC=CC=C2)N1S(=O)(=O)C1=CC=CC=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.947, <span class="s1">'O=C(NCC1=C(Br)C=CC=C1F)C1=CC=CN=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.947, <span class="s1">'COC1=C(C2=C(Cl)C=CC(S(N)(=O)=O)=C2)C=CC=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.946, <span class="s1">'O=S(=O)(NC1=CC=CC=C1)C1=CC=C(Br)C=C1'</span><span class="o">)</span>
<span class="o">(</span><span class="m">0</span>.945, <span class="s1">'O=S(=O)(NC1=CC=CC(Br)=C1)C1=CC=CC=C1'</span><span class="o">)</span>
...
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="retrosynthesis.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Retrosynthesis</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="pretrain.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Pretrained Molecular Representations</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, MilaGraph Group
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Molecule Generation</a><ul>
<li><a class="reference internal" href="#prepare-the-pretraining-dataset">Prepare the Pretraining Dataset</a></li>
<li><a class="reference internal" href="#define-the-model-gcpn">Define the Model: GCPN</a></li>
<li><a class="reference internal" href="#pretraining-and-generation-gcpn">Pretraining and Generation: GCPN</a></li>
<li><a class="reference internal" href="#goal-directed-molecule-generation-with-reinforcement-learning-gcpn">Goal-Directed Molecule Generation with Reinforcement Learning: GCPN</a></li>
<li><a class="reference internal" href="#define-the-model-graphaf">Define the Model: GraphAF</a></li>
<li><a class="reference internal" href="#pretraining-and-generation-graphaf">Pretraining and Generation: GraphAF</a></li>
<li><a class="reference internal" href="#finetuning-graphaf">Finetuning: GraphAF</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>