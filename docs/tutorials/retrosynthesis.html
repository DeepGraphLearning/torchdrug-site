<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Knowledge Graph Reasoning" href="reasoning.html" /><link rel="prev" title="Molecule Generation" href="generation.html" />

    <meta name="generator" content="sphinx-3.1.2, furo 2020.12.09.beta21"/>
        <title>Retrosynthesis - TorchDrug 0.1.1 documentation</title>
      <link rel="stylesheet" href="../_static/styles/furo.css?digest=a3f371badb8538d75df213ccffb17a4f6e8f3ac5">
    <link rel="stylesheet" href="../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --font-stack: Helvetica, Arial, sans-serif, -apple-system;
  --font-stack--monospace: Courier, monospace;
  --color-brand-primary: #E5261F;
  --color-brand-content: #E5261F;
  --admonition-font-size: 1rem;
  --admonition-title-font-size: 1rem;
  --font-size--small--2: var(--font-size--small);
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --font-stack: Helvetica, Arial, sans-serif, -apple-system;
  --font-stack--monospace: Courier, monospace;
  --color-brand-primary: #E5261F;
  --color-brand-content: #E5261F;
  --admonition-font-size: 1rem;
  --admonition-title-font-size: 1rem;
  --font-size--small--2: var(--font-size--small);
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../_static/pygments_dark.css" />
    <link rel="stylesheet" href="../_static/styles/furo-extensions.css?digest=26485485040e7aaf717c13fd0188a5ad2c2deb60">
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script defer src="../_static/jquery.js"></script>
    <script defer src="../_static/underscore.js"></script>
    <script defer src="../_static/doctools.js"></script>
    <script defer src="../_static/language_data.js"></script>
    <script defer async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script defer src="../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>


<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">TorchDrug 0.1.1 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="https://torchdrug.ai">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html">
  <input class="sidebar-search" placeholder="Search" name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../benchmark/index.html">Benchmark</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/property_prediction.html">Molecule Property Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/pretrain.html">Pretrained Molecular Representations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/generation.html">Molecule Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/retrosynthesis.html">Retrosynthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/reasoning.html">Knowledge Graph Reasoning</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="property_prediction.html">Property Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="pretrain.html">Pretrained Molecular Representations</a></li>
<li class="toctree-l2"><a class="reference internal" href="generation.html">Molecule Generation</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Retrosynthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="reasoning.html">Knowledge Graph Reasoning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes/index.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notes/graph.html">Graph Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/variadic.html">Batch Irregular Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/layer.html">Graph Neural Network Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes/model.html">Customize Models &amp; Tasks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../paper.html">Papers Implemented</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/core.html">torchdrug.core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/data.html">torchdrug.data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/datasets.html">torchdrug.datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/transforms.html">torchdrug.transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/metrics.html">torchdrug.metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/layers.html">torchdrug.layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/models.html">torchdrug.models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/tasks.html">torchdrug.tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">torchdrug.utils</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="retrosynthesis">
<h1>Retrosynthesis<a class="headerlink" href="#retrosynthesis" title="Permalink to this headline">¶</a></h1>
<p>Retrosynthesis is a fundamental task in drug discovery. Given a target molecule,
the goal of retrosynthesis is to identify a set of reactants that can produce
the target.</p>
<p>In this example, we will show how to predict retrosynthesis using <a class="reference external" href="https://arxiv.org/pdf/2003.12725.pdf">G2Gs</a> framework.
<a class="reference external" href="https://arxiv.org/pdf/2003.12725.pdf">G2Gs</a> first identifies the reaction centers, i.e., bonds generated in the
product. Based on the reaction centers, the product is broken into several
synthons and each synthon is translated to a reactant.</p>
<div class="section" id="prepare-the-dataset">
<h2>Prepare the Dataset<a class="headerlink" href="#prepare-the-dataset" title="Permalink to this headline">¶</a></h2>
<p>We use the standard <a class="reference external" href="https://aspace.repository.cam.ac.uk/bitstream/handle/1810/244727/lowethesis.pdf">USPTO50k</a> dataset. This dataset contains 50k molecules and
their synthesis pathways.</p>
<p>First, let’s download and load the dataset. This may take a while.</p>
<p>There are two modes to load the dataset. The reaction mode loads the dataset as
<code class="docutils literal notranslate"><span class="pre">(reactants,</span> <span class="pre">product)</span></code> pairs, which is used for center identification. The synthon
mode loads the dataset as <code class="docutils literal notranslate"><span class="pre">(reactant,</span> <span class="pre">synthon)</span></code> pairs, which is used for synthon
completion.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="n">reaction_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">USPTO50k</span><span class="p">(</span><span class="s2">"~/molecule-datasets/"</span><span class="p">,</span>
                                     <span class="n">node_feature</span><span class="o">=</span><span class="s2">"center_identification"</span><span class="p">,</span>
                                     <span class="n">kekulize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">synthon_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">USPTO50k</span><span class="p">(</span><span class="s2">"~/molecule-dataset/"</span><span class="p">,</span> <span class="n">as_synthon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">node_feature</span><span class="o">=</span><span class="s2">"synthon_completion"</span><span class="p">,</span>
                                    <span class="n">kekulize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we visualize some samples from the dataset. For the reaction dataset, we can
split reactant and product graphs into individual molecules using
<a class="reference internal" href="../api/data.html#torchdrug.data.Graph.connected_components" title="torchdrug.data.Graph.connected_components"><code class="xref py py-meth docutils literal notranslate"><span class="pre">connected_components()</span></code></a>.
Note <a class="reference external" href="https://aspace.repository.cam.ac.uk/bitstream/handle/1810/244727/lowethesis.pdf">USPTO50k</a> ignores all non-target products, so there is only one product on
the right hand side.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug.utils</span> <span class="kn">import</span> <span class="n">plot</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">reaction_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">reactant</span><span class="p">,</span> <span class="n">product</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">"graph"</span><span class="p">]</span>
    <span class="n">reactants</span> <span class="o">=</span> <span class="n">reactant</span><span class="o">.</span><span class="n">connected_components</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">connected_components</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">reaction</span><span class="p">(</span><span class="n">reactants</span><span class="p">,</span> <span class="n">products</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/uspto50k_0.png"><img alt="../_images/uspto50k_0.png" src="../_images/uspto50k_0.png" style="width: 49%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_1.png"><img alt="../_images/uspto50k_1.png" src="../_images/uspto50k_1.png" style="width: 49%;"/></a>
<p>Here are the corresponding samples in the synthon dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">synthon_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">reactant</span><span class="p">,</span> <span class="n">synthon</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">"graph"</span><span class="p">]</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">reaction</span><span class="p">([</span><span class="n">reactant</span><span class="p">],</span> <span class="p">[</span><span class="n">synthon</span><span class="p">])</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/uspto50k_synthon_0.png"><img alt="../_images/uspto50k_synthon_0.png" src="../_images/uspto50k_synthon_0.png" style="width: 49%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_synthon_1.png"><img alt="../_images/uspto50k_synthon_1.png" src="../_images/uspto50k_synthon_1.png" style="width: 24%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_synthon_2.png"><img alt="../_images/uspto50k_synthon_2.png" src="../_images/uspto50k_synthon_2.png" style="width: 24%;"/></a>
<p>To ensure the same split is used by both datasets, we can set the random seed
before calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">split()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">reaction_train</span><span class="p">,</span> <span class="n">reaction_valid</span><span class="p">,</span> <span class="n">reaction_test</span> <span class="o">=</span> <span class="n">reaction_dataset</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">synthon_train</span><span class="p">,</span> <span class="n">synthon_valid</span><span class="p">,</span> <span class="n">synthon_test</span> <span class="o">=</span> <span class="n">synthon_dataset</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="center-identification">
<h2>Center Identification<a class="headerlink" href="#center-identification" title="Permalink to this headline">¶</a></h2>
<p>Now we define our model. We use a Relational Graph Convolutional Network (RGCN)
as our representation model, and wrap it for the center identification task. Note
other graph representation learning models can also be used here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tasks</span>

<span class="n">reaction_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RGCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">node_feature_dim</span><span class="p">,</span>
                    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span>
                    <span class="n">num_relation</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span><span class="p">,</span>
                    <span class="n">concat_hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">reaction_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">CenterIdentification</span><span class="p">(</span><span class="n">reaction_model</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="p">(</span><span class="s2">"graph"</span><span class="p">,</span> <span class="s2">"atom"</span><span class="p">,</span> <span class="s2">"bond"</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reaction_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">reaction_task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">reaction_solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">reaction_task</span><span class="p">,</span> <span class="n">reaction_train</span><span class="p">,</span> <span class="n">reaction_valid</span><span class="p">,</span>
                              <span class="n">reaction_test</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">gpus</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">reaction_solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epoch</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">reaction_solver</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">"valid"</span><span class="p">)</span>
</pre></div>
</div>
<p>The evaluation result on the validation set may look like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>accuracy: <span class="m">0</span>.836367
</pre></div>
</div>
<p>We can show some predictions from our model. For diversity, we collect samples
from 4 different reaction types.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">reaction_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">reaction_valid</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="s2">"reaction"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reaction_set</span><span class="p">:</span>
        <span class="n">reaction_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">"reaction"</span><span class="p">])</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">break</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">graph_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">reaction_task</span><span class="o">.</span><span class="n">predict_synthon</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
<p>The following code visualizes the ground truths as well as our predictions on the
samples. We use blue for ground truths, red for wrong predictions, and purple for
correct predictions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">atoms_and_bonds</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">reaction_center</span><span class="p">):</span>
    <span class="n">is_reaction_atom</span> <span class="o">=</span> <span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atom_map</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> \
                       <span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atom_map</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> \
                        <span class="n">reaction_center</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">node_in</span><span class="p">,</span> <span class="n">node_out</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">edge_list</span><span class="o">.</span><span class="n">t</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">edge_map</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atom_map</span><span class="p">[</span><span class="n">molecule</span><span class="o">.</span><span class="n">edge_list</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">is_reaction_bond</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_map</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> \
                       <span class="p">(</span><span class="n">edge_map</span> <span class="o">==</span> <span class="n">reaction_center</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">is_reaction_atom</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="n">is_reaction_bond</span><span class="p">[</span><span class="n">node_in</span> <span class="o">&lt;</span> <span class="n">node_out</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">bonds</span>

<span class="n">products</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">"graph"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">reaction_centers</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">"reaction_center"</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">product</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">products</span><span class="p">):</span>
    <span class="n">true_atoms</span><span class="p">,</span> <span class="n">true_bonds</span> <span class="o">=</span> <span class="n">atoms_and_bonds</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">reaction_center</span><span class="p">)</span>
    <span class="n">true_atoms</span><span class="p">,</span> <span class="n">true_bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">true_atoms</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">true_bonds</span><span class="p">)</span>
    <span class="n">pred_atoms</span><span class="p">,</span> <span class="n">pred_bonds</span> <span class="o">=</span> <span class="n">atoms_and_bonds</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">reaction_centers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">pred_atoms</span><span class="p">,</span> <span class="n">pred_bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred_atoms</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred_bonds</span><span class="p">)</span>
    <span class="n">overlap_atoms</span> <span class="o">=</span> <span class="n">true_atoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pred_atoms</span><span class="p">)</span>
    <span class="n">overlap_bonds</span> <span class="o">=</span> <span class="n">true_bonds</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pred_bonds</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">true_atoms</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">pred_atoms</span><span class="p">)</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="n">true_bonds</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">pred_bonds</span><span class="p">)</span>

    <span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">purple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">atom_colors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bond_colors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">overlap_atoms</span><span class="p">:</span>
            <span class="n">atom_colors</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">purple</span>
        <span class="k">elif</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">pred_atoms</span><span class="p">:</span>
            <span class="n">atom_colors</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_colors</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">overlap_bonds</span><span class="p">:</span>
            <span class="n">bond_colors</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="n">purple</span>
        <span class="k">elif</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">pred_bonds</span><span class="p">:</span>
            <span class="n">bond_colors</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bond_colors</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span>

    <span class="n">plot</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">bonds</span><span class="p">,</span> <span class="n">atom_colors</span><span class="p">,</span> <span class="n">bond_colors</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/uspto50k_reaction_g2gs_valid_0.png"><img alt="../_images/uspto50k_reaction_g2gs_valid_0.png" src="../_images/uspto50k_reaction_g2gs_valid_0.png" style="width: 24%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_reaction_g2gs_valid_1.png"><img alt="../_images/uspto50k_reaction_g2gs_valid_1.png" src="../_images/uspto50k_reaction_g2gs_valid_1.png" style="width: 24%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_reaction_g2gs_valid_2.png"><img alt="../_images/uspto50k_reaction_g2gs_valid_2.png" src="../_images/uspto50k_reaction_g2gs_valid_2.png" style="width: 24%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_reaction_g2gs_valid_3.png"><img alt="../_images/uspto50k_reaction_g2gs_valid_3.png" src="../_images/uspto50k_reaction_g2gs_valid_3.png" style="width: 24%;"/></a>
</div>
<div class="section" id="synthon-completion">
<h2>Synthon Completion<a class="headerlink" href="#synthon-completion" title="Permalink to this headline">¶</a></h2>
<p>Similarly, we train a synthon completion model on the synthon dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">synthon_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RGCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">node_feature_dim</span><span class="p">,</span>
                            <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span>
                            <span class="n">num_relation</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bond_type</span><span class="p">,</span>
                            <span class="n">concat_hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">synthon_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">SynthonCompletion</span><span class="p">(</span><span class="n">synthon_model</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="p">(</span><span class="s2">"graph"</span><span class="p">,))</span>

<span class="n">synthon_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">synthon_task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">synthon_solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">synthon_task</span><span class="p">,</span> <span class="n">synthon_train</span><span class="p">,</span> <span class="n">synthon_valid</span><span class="p">,</span>
                             <span class="n">synthon_test</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">gpus</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">synthon_solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">synthon_solver</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">"valid"</span><span class="p">)</span>
</pre></div>
</div>
<p>We may obtain some results like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bond accuracy: <span class="m">0</span>.983013
node in accuracy: <span class="m">0</span>.967535
node out accuracy: <span class="m">0</span>.892999
stop accuracy: <span class="m">0</span>.929348
total accuracy: <span class="m">0</span>.844374
</pre></div>
</div>
<p>We then perform beam search to generate reactant candidates.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">reaction_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">synthon_valid</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="s2">"reaction"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reaction_set</span><span class="p">:</span>
        <span class="n">reaction_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">"reaction"</span><span class="p">])</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">break</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">graph_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">reactants</span><span class="p">,</span> <span class="n">synthons</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">"graph"</span><span class="p">]</span>
<span class="n">reactants</span> <span class="o">=</span> <span class="n">reactants</span><span class="o">.</span><span class="n">ion_to_molecule</span><span class="p">()</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">synthon_task</span><span class="o">.</span><span class="n">predict_reactant</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">num_beam</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_prediction</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">synthon_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">graphs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">synthon_id</span> <span class="o">!=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">synthon_id</span><span class="p">:</span>
        <span class="n">synthon_id</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">synthon_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reactants</span><span class="p">[</span><span class="n">synthon_id</span><span class="p">])</span>
        <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Truth </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">synthon_id</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reactants</span><span class="p">[</span><span class="n">synthon_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction</span><span class="p">:</span>
        <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Prediction </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">, Correct!"</span> <span class="o">%</span> <span class="p">(</span><span class="n">synthon_id</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Prediction </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">synthon_id</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

<span class="c1"># reset attributes so that pack can work properly</span>
<span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">to_molecule</span><span class="p">()</span> <span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="n">graphs</span><span class="p">]</span>
<span class="n">graphs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">PackedMolecule</span><span class="o">.</span><span class="n">from_molecule</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
<span class="n">graphs</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">titles</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="s2">"uspto50k_synthon_valid.png"</span><span class="p">,</span> <span class="n">num_col</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>For each row in the visualization, the first molecule corresponds to the ground truth.
The rest molecules are candidates from beam search, ordered by their log likelihood.
We can see that our model can recall ground truth in top-5 predictions for most samples.</p>
<img alt="../_images/uspto50k_synthon_g2gs_valid.png" src="../_images/uspto50k_synthon_g2gs_valid.png"/>
</div>
<div class="section" id="id3">
<h2>Retrosynthesis<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Given the trained models, we can combine them into an end2end pipeline for
retrosynthesis. This is done by wrapping the two sub tasks with a retrosynthesis task.</p>
<p>The pipeline will perform beam search over all possible combinations between the
predictions from two sub tasks. For demonstration, we use a small beam size and
only evaluate on a subset of the validation set. Note the results will be better
if we give more budget to the beam search.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">reaction_valid</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span>
           <span class="nb">len</span><span class="p">(</span><span class="n">reaction_valid</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">reaction_valid</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">reaction_valid_small</span> <span class="o">=</span> <span class="n">torch_data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">reaction_valid</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">Retrosynthesis</span><span class="p">(</span><span class="n">reaction_task</span><span class="p">,</span> <span class="n">synthon_task</span><span class="p">,</span> <span class="n">center_topk</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_beam</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">max_prediction</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Engine</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">reaction_train</span><span class="p">,</span> <span class="n">reaction_valid_small</span><span class="p">,</span> <span class="n">reaction_test</span><span class="p">,</span>
                     <span class="n">optimizer</span><span class="p">,</span> <span class="n">gpus</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>To load parameters two sub tasks, we just load each checkpoint. Note <code class="docutils literal notranslate"><span class="pre">load_optimizer</span></code>
should be set to <code class="docutils literal notranslate"><span class="pre">False</span></code> to avoid conflicts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reaction_solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"g2gs_reaction_model.pth"</span><span class="p">)</span>
<span class="n">synthon_solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"g2gs_synthon_model.pth"</span><span class="p">)</span>

<span class="n">reaction_task</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">reaction_train</span><span class="p">)</span>
<span class="n">synthon_task</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">synthon_train</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"g2gs_reaction_model.pth"</span><span class="p">,</span> <span class="n">load_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"g2gs_synthon_model.pth"</span><span class="p">,</span> <span class="n">load_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">"valid"</span><span class="p">)</span>
</pre></div>
</div>
<p>The accuracy for retrosynthesis may be close to the following.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>top-1 accuracy: <span class="m">0</span>.47541
top-3 accuracy: <span class="m">0</span>.741803
top-5 accuracy: <span class="m">0</span>.827869
top-10 accuracy: <span class="m">0</span>.879098
</pre></div>
</div>
<p>Here are the top-1 predictions for samples in the validation set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">reaction_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">reaction_valid</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="s2">"reaction"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reaction_set</span><span class="p">:</span>
        <span class="n">reaction_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">"reaction"</span><span class="p">])</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">break</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">graph_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">predictions</span><span class="p">,</span> <span class="n">num_prediction</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

<span class="n">top1_index</span> <span class="o">=</span> <span class="n">num_prediction</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_prediction</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)):</span>
    <span class="n">reactant</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">top1_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">connected_components</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">products</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">connected_components</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">reaction</span><span class="p">(</span><span class="n">reactant</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/uspto50k_retrosynthesis_g2gs_valid_0.png"><img alt="../_images/uspto50k_retrosynthesis_g2gs_valid_0.png" src="../_images/uspto50k_retrosynthesis_g2gs_valid_0.png" style="width: 49%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_retrosynthesis_g2gs_valid_1.png"><img alt="../_images/uspto50k_retrosynthesis_g2gs_valid_1.png" src="../_images/uspto50k_retrosynthesis_g2gs_valid_1.png" style="width: 49%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_retrosynthesis_g2gs_valid_2.png"><img alt="../_images/uspto50k_retrosynthesis_g2gs_valid_2.png" src="../_images/uspto50k_retrosynthesis_g2gs_valid_2.png" style="width: 49%;"/></a>
<a class="reference internal image-reference" href="../_images/uspto50k_retrosynthesis_g2gs_valid_3.png"><img alt="../_images/uspto50k_retrosynthesis_g2gs_valid_3.png" src="../_images/uspto50k_retrosynthesis_g2gs_valid_3.png" style="width: 49%;"/></a>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="reasoning.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Knowledge Graph Reasoning</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="generation.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Molecule Generation</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, MilaGraph Group
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../_sources/tutorials/retrosynthesis.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Retrosynthesis</a><ul>
<li><a class="reference internal" href="#prepare-the-dataset">Prepare the Dataset</a></li>
<li><a class="reference internal" href="#center-identification">Center Identification</a></li>
<li><a class="reference internal" href="#synthon-completion">Synthon Completion</a></li>
<li><a class="reference internal" href="#id3">Retrosynthesis</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
  </body>
</html>