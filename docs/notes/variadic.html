<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Graph Neural Network Layers" href="layer.html" /><link rel="prev" title="Graph Data Structures" href="graph.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>Batch Irregular Structures - TorchDrug 0.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --font-stack: Helvetica, Arial, sans-serif, -apple-system;
  --font-stack--monospace: Courier, monospace;
  --color-brand-primary: #E5261F;
  --color-brand-content: #E5261F;
  --admonition-font-size: 1rem;
  --admonition-title-font-size: 1rem;
  --font-size--small--2: var(--font-size--small);
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">TorchDrug 0.1.3 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="https://torchdrug.ai">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../benchmark/index.html">Benchmark</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/property_prediction.html">Molecule Property Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/pretrain.html">Pretrained Molecular Representations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/generation.html">Molecule Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/retrosynthesis.html">Retrosynthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmark/reasoning.html">Knowledge Graph Reasoning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/property_prediction.html">Property Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/pretrain.html">Pretrained Molecular Representations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/generation.html">Molecule Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/retrosynthesis.html">Retrosynthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/reasoning.html">Knowledge Graph Reasoning</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Notes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="graph.html">Graph Data Structures</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Batch Irregular Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="layer.html">Graph Neural Network Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="model.html">Customize Models &amp; Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference.html">Deal with References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../paper.html">Papers Implemented</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/core.html">torchdrug.core</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/data.html">torchdrug.data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/datasets.html">torchdrug.datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/transforms.html">torchdrug.transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/metrics.html">torchdrug.metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/layers.html">torchdrug.layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/models.html">torchdrug.models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/tasks.html">torchdrug.tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">torchdrug.utils</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="batch-irregular-structures">
<h1>Batch Irregular Structures<a class="headerlink" href="#batch-irregular-structures" title="Permalink to this headline">#</a></h1>
<p>Unlike images, text and audio, graphs usually have irregular structures, which
makes them hard to batch in tensor frameworks. Many existing implementations use
padding to convert graphs into dense grid structures, which costs much unnecessary
computation and memory.</p>
<p>In TorchDrug, we develop a more intuitive and efficient solution based on
variadic functions. The variadic functions can directly operate on sparse irregular
inputs or outputs.</p>
<section id="variadic-input">
<h2>Variadic Input<a class="headerlink" href="#variadic-input" title="Permalink to this headline">#</a></h2>
<p>Here we show how to apply functions to variadic inputs.</p>
<p>Generally, a batch of <span class="math notranslate nohighlight">\(n\)</span> variadic tensors can be represented by a value
tensor and a size tensor. The value tensor is a concatenation of all variadic
tensors along the variadic axis, while the size tensor indicates how big each
variadic tensor is.</p>
<p>Let’s first create a batch of 1D variadic samples.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,)))</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">])</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/variadic_tensor.png"><img alt="../_images/variadic_tensor.png" class="align-center" src="../_images/variadic_tensor.png" style="width: 60%;"/></a>
<p>We apply variadic functions to compute the sum, max and top-k values for each
sample.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug.layers</span> <span class="kn">import</span> <span class="n">functional</span>

<span class="nb">sum</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">variadic_sum</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="nb">max</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">variadic_max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top3_value</span><span class="p">,</span> <span class="n">top3_index</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">variadic_topk</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Note <a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_topk" title="torchdrug.layers.functional.variadic_topk"><code class="xref py py-meth docutils literal notranslate"><span class="pre">variadic_topk</span></code></a> accepts
samples smaller than <span class="math notranslate nohighlight">\(k\)</span>. In this case, it will fill the output with the
smallest element from that sample.</p>
<a class="reference internal image-reference" href="../_images/variadic_func_result.png"><img alt="../_images/variadic_func_result.png" class="align-center" src="../_images/variadic_func_result.png" style="width: 88%;"/></a>
<p>Mathematically, these functions can be viewed as performing the operation over
each sample with a for loop. For example, the variadic sum is equivalent to the
following logic.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sums</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
    <span class="n">sums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="nb">sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sums</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In spite of the same logic, variadic functions is much faster than for loops
on GPUs (typically <span class="math notranslate nohighlight">\(\text{batch size}\times\)</span> faster). Use variadic functions
instead of for loops whenever possible.</p>
</div>
<p>Many operations in graph representation learning can be implemented by variadic
functions. For example,</p>
<ol class="arabic simple">
<li><p>Infer graph-level representations from node-/edge-level representations.</p></li>
<li><p>Perform classification over nodes/edges.</p></li>
</ol>
<p>Here we demonstrate how to perform classification over nodes. We create a toy
task, where the model needs to predict the heaviest atom of each molecule. Note
that node attributes form variadic tensors with <code class="docutils literal notranslate"><span class="pre">num_nodes</span></code> from the same graph.
Therefore, we can use <a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_max" title="torchdrug.layers.functional.variadic_max"><code class="xref py py-meth docutils literal notranslate"><span class="pre">variadic_max</span></code></a>
to get our ground truth.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdrug</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">metrics</span>

<span class="n">smiles_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"CC(=C)C#N"</span><span class="p">,</span> <span class="s2">"CCNC(=S)NCC"</span><span class="p">,</span> <span class="s2">"BrC1=CC=C(Br)C=C1"</span><span class="p">]</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">PackedMolecule</span><span class="o">.</span><span class="n">from_smiles</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">variadic_max</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Naturally, the prediction over nodes also forms a variadic tensor with <code class="docutils literal notranslate"><span class="pre">num_nodes</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GCN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">node_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">feature</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">node_feature</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">"node_feature"</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">pred_prob</span><span class="p">,</span> <span class="n">pred_index</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">variadic_max</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">variadic_cross_entropy</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">variadic_accuracy</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_sum" title="torchdrug.layers.functional.variadic_sum"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_sum</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_mean" title="torchdrug.layers.functional.variadic_mean"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_mean</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_max" title="torchdrug.layers.functional.variadic_max"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_max</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_arange" title="torchdrug.layers.functional.variadic_arange"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_arange</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_sort" title="torchdrug.layers.functional.variadic_sort"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_sort</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_topk" title="torchdrug.layers.functional.variadic_topk"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_topk</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_randperm" title="torchdrug.layers.functional.variadic_randperm"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_randperm</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_sample" title="torchdrug.layers.functional.variadic_sample"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_sample</span></code></a>,
<code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_meshgrid</span> <span class="pre">&lt;torchdrug.layers.functional.variadic_meshgrid()</span></code>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_softmax" title="torchdrug.layers.functional.variadic_softmax"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_softmax</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_log_softmax" title="torchdrug.layers.functional.variadic_log_softmax"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_log_softmax</span></code></a>,
<a class="reference internal" href="../api/layers.html#torchdrug.layers.functional.variadic_cross_entropy" title="torchdrug.layers.functional.variadic_cross_entropy"><code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_cross_entropy</span></code></a>,
<code class="xref py py-func docutils literal notranslate"><span class="pre">variadic_accuracy</span></code></p>
</div>
</section>
<section id="variadic-output">
<h2>Variadic Output<a class="headerlink" href="#variadic-output" title="Permalink to this headline">#</a></h2>
<p>In some cases, we also need to write functions that produce variadic outputs. A
typical example is autoregressive generation, where we need to generate all
node/edge prefixes of a graph. When this operation is batched, we need to output
variadic numbers of graphs for different input graphs.</p>
<p>Here we show how to generate edge prefixes for a batch of graphs in TorchDrug.
First, let’s prepare a batch of two graphs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">edge_list</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
<span class="n">graph1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">edge_list</span><span class="p">,</span> <span class="n">num_node</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">edge_list</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
<span class="n">graph2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">edge_list</span><span class="p">,</span> <span class="n">num_node</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">pack</span><span class="p">([</span><span class="n">graph1</span><span class="p">,</span> <span class="n">graph2</span><span class="p">])</span>
<span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">():</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/autoregressive_input.png"><img alt="../_images/autoregressive_input.png" class="align-center" src="../_images/autoregressive_input.png" style="width: 66%;"/></a>
<p>The generation of edge prefixes consists 3 steps.</p>
<ol class="arabic simple">
<li><p>Construct an extended batch with enough copies for each graph.</p></li>
<li><p>Apply an edge mask over the batch.</p></li>
<li><p>Remove excess or invalid graphs.</p></li>
</ol>
<p>The first step can be implemented through
<a class="reference internal" href="../api/data.html#torchdrug.data.Graph.repeat" title="torchdrug.data.Graph.repeat"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Graph.repeat</span></code></a>. For the following steps, we
define an auxiliary function <code class="docutils literal notranslate"><span class="pre">all_prefix_slice</span></code>. This function takes in a size
tensor and desired prefix lengths, and outputs <span class="math notranslate nohighlight">\(n*l\)</span> prefix slices for the
extended batch, where <span class="math notranslate nohighlight">\(n\)</span> is the batch size and <span class="math notranslate nohighlight">\(l\)</span> is the number of
prefix lengths.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">all_prefix_slice</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cum_sizes</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">cum_sizes</span> <span class="o">-</span> <span class="n">sizes</span>
    <span class="k">if</span> <span class="n">lengths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">sizes</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">pack_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">sizes</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_cum_xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">starts</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pack_offsets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sizes</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sizes</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">starts</span> <span class="o">+</span> <span class="n">lengths</span>

    <span class="n">starts</span> <span class="o">=</span> <span class="n">starts</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">ends</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">,</span> <span class="n">valid</span>

<span class="n">lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_edges</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">num_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
<span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">all_prefix_slice</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">num_edges</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span>
</pre></div>
</div>
<p>The slices are visualized as follows. Two colors correspond to two input graphs.</p>
<a class="reference internal image-reference" href="../_images/autoregressive_slice.png"><img alt="../_images/autoregressive_slice.png" class="align-center" src="../_images/autoregressive_slice.png" style="width: 55%;"/></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_length</span><span class="p">)</span> <span class="c1"># step 1</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">multi_slice_mask</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edge_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="c1"># step 2</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="c1"># step 3</span>
</pre></div>
</div>
<p>The output batch is</p>
<img alt="../_images/autoregressive_output.png" src="../_images/autoregressive_output.png"/>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="layer.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Graph Neural Network Layers</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="graph.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Graph Data Structures</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, MilaGraph Group
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Batch Irregular Structures</a><ul>
<li><a class="reference internal" href="#variadic-input">Variadic Input</a></li>
<li><a class="reference internal" href="#variadic-output">Variadic Output</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>